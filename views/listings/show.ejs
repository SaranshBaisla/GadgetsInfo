<% layout("layouts/boilerplate") %>
<body>
  <div class="container mt-4">
    <div class="row">
      
      <!-- LEFT: Product Image -->
      <div class="col-md-5 text-center">
        <img src="<%= listing.images?.url || '/images/default.png' %>" 
             class="img-fluid show-img" 
             alt="<%= listing.title %>">
        <p class="mt-2 text-muted">
          Owned by <span class="text-danger"><%= listing.owner.username %></span>
        </p>
      </div>

      <!-- RIGHT: Product Info + Specs -->
      <div class="col-md-7">
        <h2 class="mb-3"><%= listing.title %></h2>
        <p><%= listing.description %></p>

        <% function formatINR(amount) { 
             return new Intl.NumberFormat("en-IN").format(amount); 
           } 
        %>

        <h4 class="text-success mb-3">
          ‚Çπ <%= formatINR(listing.price * 83) %>
          <span class="text-muted" style="font-size: small;">(approx.)</span>
        </h4>

        <ul class="list-unstyled mb-4">
          <li><b>Category:</b> <%= listing.category %></li>
          <li><b>Launch Date:</b> <%= listing.launchDate %></li>
          <li><b>Spec Score:</b> ‚≠ê <%= listing.specScore %>/100</li>
        </ul>

        <% if (listing.specs && Object.keys(listing.specs).length > 0) { %>
          <h4 class="mt-4">Specifications</h4>
          <div class="table-responsive">
            <table class="table table-bordered table-striped table-sm text-break">
              <tbody>
                <% for (let [category, details] of Object.entries(listing.specs)) { %>
                  <% if (typeof details === "object" && details !== null && !Array.isArray(details)) { %>
                    <% Object.entries(details).forEach(([specKey, specValue]) => { %>
                      <tr>
                        <th><%= specKey %></th>
                        <td><%= Array.isArray(specValue) ? specValue.join(", ") : specValue %></td>
                      </tr>
                    <% }) %>
                  <% } else { %>
                    <tr>
                      <th><%= category %></th>
                      <td><%= details %></td>
                    </tr>
                  <% } %>
                <% } %>
              </tbody>
            </table>
          </div>
        <% } %>

        <!-- Owner Actions -->
        <% if (isOwner) { %>
          <div class="d-flex gap-3 mt-3">
            <a href="/listings/<%= listing._id %>/edit" class="btn btn-secondary">Edit</a>
            <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
              <button type="submit" class="btn btn-danger">Delete</button>
            </form>
          </div>
        <% } %>

        <!-- Review Section -->
        <% if(currUser){ %>
          <h4 class="mt-4">Leave a Review</h4>
          <form action="/listings/<%= listing._id %>/reviews" method="POST" class="mb-4">

            <fieldset class="starability-fade">
              <legend>Rating:</legend>
              <input type="radio" id="first-rate1" name="review[rating]" value="1" />
              <label for="first-rate1" title="Terrible">1 star</label>
              <input type="radio" id="first-rate2" name="review[rating]" value="2" />
              <label for="first-rate2" title="Not good">2 stars</label>
              <input type="radio" id="first-rate3" name="review[rating]" value="3" />
              <label for="first-rate3" title="Average">3 stars</label>
              <input type="radio" id="first-rate4" name="review[rating]" value="4" />
              <label for="first-rate4" title="Very good">4 stars</label>
              <input type="radio" id="first-rate5" name="review[rating]" value="5" />
              <label for="first-rate5" title="Amazing">5 stars</label>
            </fieldset>

            <br>

            <!-- Comment -->
            <div class="mb-2 col-4">
              <label class="form-label fw-semibold">Comment:</label>
              <textarea class="form-control" name="review[comment]" rows="3" required></textarea>
            </div>

            <!-- Submit -->
            <button type="submit" class="btn btn-outline-dark">Add Review</button>
          </form>
        <% } %>

        <!-- All Reviews -->
        <h4 class="mt-4"><b>All Reviews</b></h4>
        <div class="row">
          <% for (let review of listing.reviews) { %>
            <div class="col-md-5 mb-3">
              <div class="card h-100">
                <div class="card-body">
                  <h6 class="card-title">@<%= review.author.username %></h6>
                  <p class="starability-result" data-rating="<%= review.rating %>"></p>
                  <small class="text-muted">Rated <%= review.rating %>/5</small>
                  <p class="card-text">üîπ <%= review.comment %></p>
                </div>
                <div class="card-footer bg-white border-0">
                  <% if (currUser && (currUser._id.toString() === review.author._id.toString() || isOwner)) { %>
                    <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                      <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                  <% } %>
                </div>
              </div>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Styles -->
  <style>
    .product-img {
      max-height: 400px;
      object-fit: contain;
    }
    .specs-table {
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-top: 10px;
    }
    .spec-row {
      border-bottom: 1px solid #eee;
      padding: 8px 12px;
    }
    .spec-row:last-child {
      border-bottom: none;
    }
    .spec-key {
      font-weight: bold;
      background: #f8f9fa;
    }
    .spec-value {
      background: #fff;
    }
  </style>
</body>
