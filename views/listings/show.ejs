<% layout("layouts/boilerplate") %>
<body>
  <div class="container mt-4">
    <div class="row">
      
      <!-- LEFT: Product Image -->
      <div class="col-md-5 text-center">
        <img src="<%= listing.images.url %>" class="img-fluid show-img" alt="<%= listing.title %>">
        <p class="mt-2 text-muted">Owned by <span class="text-danger"><%= listing.owner.username %></span></p>
      </div>

      <!-- RIGHT: Product Info + Specs -->
      <div class="col-md-7">
        <h2 class="mb-3"><%= listing.title %></h2>
        <p><%= listing.description %></p>

        <h4 class="text-success mb-3">
          ‚Çπ <%= (listing.price * 83).toLocaleString("en-IN") %> 
          <span class="text-muted" style="font-size: small;">(approx.)</span>
        </h4>

        <ul class="list-unstyled mb-4">
          <li><b>Category:</b> <%= listing.category %></li>
          <li><b>Launch Date:</b> <%= listing.launchDate %></li>
          <li><b>Spec Score:</b> ‚≠ê <%= listing.specScore %>/100</li>
        </ul>


        <%
function renderSpecValue(value) {
  if (Array.isArray(value)) {
    // If it's an array, join the elements with ": " or ", "
    return value.slice(1).join(", "); // skips first if you store label there
  } else if (typeof value === "object" && value !== null) {
    // If it's an object, recursively render
    return Object.entries(value)
      .map(([k, v]) => `${k}: ${renderSpecValue(v)}`)
      .join(", ");
  } else {
    // primitive value (string/number)
    return value;
  }
}
%>


<% if (listing.specs && listing.specs.size) { %>
  <h4 class="mt-4">Specifications</h4>
  <div class="table-responsive">
    <table class="table table-bordered table-striped">
      <tbody>
        <% for (let [category, details] of listing.specs) { %>
          <% 
            // If details is an object (nested specs, e.g., General: { Processor: ..., RAM: ... })
            if (typeof details === "object" && details !== null && !Array.isArray(details)) { 
          %>
            <% Object.entries(details).forEach(([specKey, specValue]) => { %>
              <% if (specKey !== "Key" && specKey !== "Value") { %>
                <tr>
                  <th><%= specKey %></th>
                  <td>
                    <% if (Array.isArray(specValue)) { %>
                      <%= specValue.join(", ") %>
                    <% } else { %>
                      <%= specValue %>
                    <% } %>
                  </td>
                </tr>
              <% } %>
            <% }) %>
          <% } else { %>
            <!-- Simple flat key:value -->
            <tr>
              <th><%= category %></th>
              <td><%= details %></td>
            </tr>
          <% } %>
        <% } %>
      </tbody>
    </table>
  </div>
<% } %>



        <!-- Owner Actions -->
        <% if(currUser && currUser._id.equals(listing.owner._id)){ %>
          <div class="d-flex gap-3 mt-3">
            <a href="/listings/<%= listing._id %>/edit" class="btn btn-secondary">Edit</a> 
            <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE">
              <button type="submit" class="btn btn-danger">Delete</button>
            </form>
          </div>
        <% } %>
      </div>
    </div>

    <hr class="my-4">

    <!-- Review Section -->
  <% if(currUser){ %>
  <h4>Leave a Review</h4>
  <form action="/listings/<%= listing._id %>/reviews" method="POST" class="mb-4">

<fieldset class="starability-fade">
  <legend>Rating:</legend>

  <input type="radio" id="first-rate1" name="review[rating]" value="1" />
  <label for="first-rate1" title="Terrible">1 star</label>

  <input type="radio" id="first-rate2" name="review[rating]" value="2" />
  <label for="first-rate2" title="Not good">2 stars</label>

  <input type="radio" id="first-rate3" name="review[rating]" value="3" />
  <label for="first-rate3" title="Average">3 stars</label>

  <input type="radio" id="first-rate4" name="review[rating]" value="4" />
  <label for="first-rate4" title="Very good">4 stars</label>

  <input type="radio" id="first-rate5" name="review[rating]" value="5" />
  <label for="first-rate5" title="Amazing">5 stars</label>
</fieldset>

<br>

    <!--Comment -->
    <div class="mb-2 col-4">
      <label class="form-label fw-semibold">Comment:</label>
      <textarea class="form-control" name="review[comment]" rows="3" required></textarea>
    </div>

    <!-- Submit -->
    <button type="submit" class="btn btn-outline-dark">Add Review</button>
  </form>
<% } %>


    <!-- All Reviews -->
    <h4 class="mt-4"><b>All Reviews</b></h4>
    <div class="row">
      <% for (let review of listing.reviews) { %>
        <div class="col-md-5 mb-3">
          <div class="card h-100">
            <div class="card-body">
              <h6 class="card-title">@<%= review.author.username %></h6>
              <p class="starability-result" data-rating=<%= review.rating %>>
                 <%= review.rating %></p> 
                  
              <p class="card-text">üîπ <%= review.comment %></p>
              
            </div>
            
            <div class="card-footer bg-white border-0">
              <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  </div>

  <!-- Styles -->
  <style>
    .product-img {
      max-height: 400px;
      object-fit: contain;
    }
    .specs-table {
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-top: 10px;
    }
    .spec-row {
      border-bottom: 1px solid #eee;
      padding: 8px 12px;
    }
    .spec-row:last-child {
      border-bottom: none;
    }
    .spec-key {
      font-weight: bold;
      background: #f8f9fa;
    }
    .spec-value {
      background: #fff;
    }
  </style>
</body>

